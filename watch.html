<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMOKIN PURP – Watch</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: #fff;
            background-color: #000;
            background-size: cover;
            background-position: center;
        }
        .header {
            padding: 1rem;
            background: #111;
            display: flex;
            align-items: center;
        }
        .header a {
            color: #61dafb;
            text-decoration: none;
            margin-right: 1rem;
            font-size: 1rem;
        }
        .container {
            display: flex;
            justify-content: center;
            margin: 1rem;
        }
        iframe {
            width: 100%;
            max-width: 960px;
            height: 540px;
            border: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" style="color:#61dafb;text-decoration:none;">← Back to Search</a>
        <span id="video-title" style="margin-left:1rem;font-weight:bold;"></span>
    </div>
    <div class="container">
        <iframe id="player" allowfullscreen></iframe>
    </div>
    <script>
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }
        function decodeHtml(html) {
            const txt = document.createElement('textarea');
            txt.innerHTML = html;
            return txt.value;
        }
        async function loadVideo() {
            const videoId = getQueryParam('videoId');
            if (!videoId) {
                document.getElementById('video-title').textContent = 'Invalid video';
                return;
            }
            // Set iframe source to Invidious embed
            const player = document.getElementById('player');
            player.src = `https://yewtu.be/embed/${videoId}?autoplay=1`;
            // Fetch some metadata for the title
            try {
                const resp = await fetch(`https://yewtu.be/api/v1/videos/${videoId}`);
                if (resp.ok) {
                    const data = await resp.json();
                    document.getElementById('video-title').textContent = data.title;
                }
            } catch (err) {
                console.error(err);
            }
        }
        // Weather handling for watch page
        const weatherImages = {
            sunny: 'sunny.png',
            cloudy: 'cloudy.png',
            rainy: 'rainy.png',
            snowy: 'snowy.png'
        };
        function setBackground(code) {
            let key;
            if (code === 0) key = 'sunny';
            else if (code >= 1 && code <= 3) key = 'cloudy';
            else if ((code >= 45 && code <= 48) || (code >= 51 && code <= 67) || (code >= 80 && code <= 82) || code >= 95) key = 'rainy';
            else if ((code >= 71 && code <= 77) || code === 85 || code === 86) key = 'snowy';
            else key = 'cloudy';
            document.body.style.backgroundImage = `url('${weatherImages[key]}')`;
        }
        function fetchWeather(lat, lon) {
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
            fetch(url)
                .then(res => res.json())
                .then(data => {
                    const code = data.current_weather ? data.current_weather.weathercode : 0;
                    setBackground(code);
                })
                .catch(() => setBackground(0));
        }
        function initWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    fetchWeather(pos.coords.latitude, pos.coords.longitude);
                }, () => {
                    fetchWeather(42.3314, -83.0458);
                });
            } else {
                fetchWeather(42.3314, -83.0458);
            }
        }
        function init() {
            loadVideo();
            initWeather();
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>